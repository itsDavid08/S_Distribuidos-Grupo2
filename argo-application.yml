# (Baseado no Relatório_Final_CI_CD.pdf, p. 55, e Lab 6.docx)

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  # Nome da sua aplicação no dashboard do Argo CD
  name: projeto-streaming
  namespace: argocd
spec:
  project: default

  # --- A FONTE (O SEU GIT) ---
  source:
    # 1. O URL do seu repositório
    repoURL: https://github.com/itsDavid08/S_Distribuidos-Grupo2.git 
    
    # 2. A branch a monitorizar (como corrigimos)
    targetRevision: main 
    
    # 3. A pasta que contém os seus YAMLs de deploy
    path: K8s-Config/ 
    
    # 4. A OPÇÃO CRÍTICA:
    # Diz ao Argo CD para ler as subpastas (Infraestrutura/Mongo/, etc.)
    directory:
      recurse: true 

  # --- O DESTINO (O SEU CLUSTER) ---
  destination:
    # URL padrão do cluster local (Docker Desktop)
    server: https://kubernetes.default.svc 

  # --- POLÍTICA DE SINCRONIZAÇÃO (A Magia do GitOps) ---
  syncPolicy:
    automated:
      # Repara automaticamente se alguém alterar o cluster manualmente
      selfHeal: true 
      # Apaga recursos do cluster que já não existem no Git
      prune: true 
    syncOptions:
    - CreateNamespace=true # Cria o namespace 'default' se não existir
    - PrunePropagationPolicy=foreground
    - PruneLast=true