# argo-application.yml
# (Baseado no Relatório_Final_CI_CD.pdf, p. 55, e Lab 6.docx)

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  # Nome da sua aplicação no dashboard do Argo CD
  name: projeto-streaming
  namespace: argocd
  
  # --- ANOTAÇÕES PARA O ARGOCD IMAGE UPDATER ---
  annotations:
    # 1. Lista de imagens a monitorizar no Docker Hub
    argocd-image-updater.argoproj.io/image-list: |
      ui=kingdavid08/ui
      consumer=kingdavid08/consumer
      producer=kingdavid08/producer

    # 2. Estratégia de atualização para a UI
    argocd-image-updater.argoproj.io/ui.update-strategy: latest
    argocd-image-updater.argoproj.io/ui.allow-tags: regexp:^[0-9]+$

    # 3. Estratégia de atualização para o Consumer
    argocd-image-updater.argoproj.io/consumer.update-strategy: latest
    argocd-image-updater.argoproj.io/consumer.allow-tags: regexp:^[0-9]+$

    # 4. Estratégia de atualização para o Producer
    argocd-image-updater.argoproj.io/producer.update-strategy: latest
    argocd-image-updater.argoproj.io/producer.allow-tags: regexp:^[0-9]+$

    # 5. Configuração do write-back para Git
    # O Image Updater fará commit e push das alterações
    argocd-image-updater.argoproj.io/write-back-method: git
    argocd-image-updater.argoproj.io/git-commit-message: "CD: Atualiza imagem {{image_name}} para a tag {{image_tag}}"

spec:
  project: default

  # --- A FONTE (O SEU GIT) ---
  source:
    # 1. O URL do seu repositório
    repoURL: https://github.com/itsDavid08/S_Distribuidos-Grupo2.git 
    
    # 2. A branch a monitorizar (como corrigimos)
    targetRevision: main 
    
    # 3. A pasta que contém os seus YAMLs de deploy
    path: K8s-Config/ 
    
    # 4. A OPÇÃO CRÍTICA:
    # Diz ao Argo CD para ler as subpastas (Infraestrutura/Mongo/, etc.)
    directory:
      recurse: true 

  # --- O DESTINO (O SEU CLUSTER) ---
  destination:
    # URL padrão do cluster local (Docker Desktop)
    server: https://kubernetes.default.svc 
    # O namespace onde os seus serviços (UI, Mongo, etc.) serão implementados
    namespace: default 

  # --- POLÍTICA DE SINCRONIZAÇÃO (A Magia do GitOps) ---
  syncPolicy:
    automated:
      # Repara automaticamente se alguém alterar o cluster manualmente
      selfHeal: true 
      # Apaga recursos do cluster que já não existem no Git
      prune: true 
    syncOptions:
    - CreateNamespace=true # Cria o namespace 'default' se não existir